<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JWT Microservices Demo (RS256 + Offline Verification)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    .row { display: flex; gap: 24px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; max-width: 520px; flex: 1; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #aaa; background: #f7f7f7; cursor: pointer; }
    input { padding: 10px; border-radius: 10px; border: 1px solid #ccc; width: 100%; }
    pre { background: #0b1020; color: #e8ecff; padding: 12px; border-radius: 12px; overflow: auto; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .hint { color: #555; font-size: 14px; }
  </style>
</head>
<body>
  <h1>JWT Microservices Demo</h1>
  <p class="hint">
    This demo logs in once (hardcoded credentials) to get an <b>RS256</b> JWT from the auth service,
    then calls two microservices (<code>catalog</code> and <code>orders</code>) using the same token.
    The microservices validate the JWT <b>offline</b> using the public key file (no auth-service call).
  </p>

  <div class="row">
    <div class="card">
      <h2>1) Login</h2>
      <p class="hint">Use: <code>demo@example.com</code> / <code>secret123</code></p>
      <label>Email</label>
      <input id="email" value="demo@example.com" />
      <label style="margin-top:8px;display:block;">Password</label>
      <input id="password" type="password" value="secret123" />
      <div style="margin-top:12px;">
        <button id="loginBtn">Login â†’ Get JWT</button>
      </div>
      <h3>Access Token (JWT)</h3>
      <pre id="tokenBox">(not logged in)</pre>
    </div>

    <div class="card">
      <h2>2) Call Microservices</h2>
      <div style="display:flex; gap: 10px; flex-wrap: wrap;">
        <button id="catalogBtn">GET /catalog/products</button>
        <button id="ordersBtn">GET /orders/ping</button>
      </div>
      <h3>Response</h3>
      <pre id="respBox">(no calls yet)</pre>
    </div>
  </div>

<script>
let accessToken = null;

function setText(id, text) {
  document.getElementById(id).textContent = text;
}

async function login() {
  setText('respBox', '(logging in...)');
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;

  const res = await fetch('/api/auth/login', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({email, password})
  });

  const data = await res.json().catch(() => ({}));
  if (!res.ok) {
    setText('respBox', JSON.stringify(data, null, 2));
    setText('tokenBox', '(not logged in)');
    accessToken = null;
    return;
  }
  accessToken = data.access_token;
  setText('tokenBox', accessToken);
  setText('respBox', JSON.stringify({message: 'Logged in. Token stored in JS memory only.'}, null, 2));
}

async function callApi(path) {
  if (!accessToken) {
    setText('respBox', 'Please login first.');
    return;
  }
  setText('respBox', '(calling ' + path + ' ...)');
  const res = await fetch(path, {
    headers: {'Authorization': 'Bearer ' + accessToken}
  });
  const data = await res.json().catch(() => ({}));
  setText('respBox', JSON.stringify({status: res.status, body: data}, null, 2));
}

document.getElementById('loginBtn').addEventListener('click', login);
document.getElementById('catalogBtn').addEventListener('click', () => callApi('/api/catalog/products'));
document.getElementById('ordersBtn').addEventListener('click', () => callApi('/api/orders/ping'));
</script>
</body>
</html>
